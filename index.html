<!DOCTYPE html>

<html>

<head>
  <title>Personal Finance Dashboard</title>
  <link rel="stylesheet" href="./assets/bootstrap.min.css">
  <script src="./assets/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
  <nav class="p-2 navbar bg-primary text-light mb-3">
    <h3>Personal Finance Dashboard</h3>
    <label for="import-year" class="btn btn-secondary">Import Year</label>
    <input type="file" id="import-year" accept="json" class="d-none" onchange="FinanceRecord.import_year()">
  </nav>
  <main class="px-2">
    <div>
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#year-modal">New Year</button>
      <div class="row">
        <div class="col-3">
          <label for="year" class="form-label fw-bold">Year</label>
          <select id="year-select" class="form-select mb-3" onchange="FinanceRecord.cur_year = this.value"></select>
        </div>
        <div class="col-3">
          <label for="month" class="form-label fw-bold">Month</label>
          <select id="month-select" class="form-select mb-3" onchange="FinanceRecord.cur_month = this.value">
            <option value="0" selected>January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
        </div>
      </div>
      <btn class="btn btn-primary" id="export" style="display: none;" onclick="FinanceRecord.export_year()">Export Year
      </btn>
    </div>

    <ul class="nav nav-tabs my-3" id="nav-tabs" style="display: none;">
      <li class="nav-item">
        <a class="nav-link" id="income-link" onclick="show_tab('income')">Income</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="expenses-link" onclick="show_tab('expenses')">Expenses</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="accounts-link" onclick="show_tab('accounts')">Accounts</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="assets-link" onclick="show_tab('assets')">Assets</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="loans-link" onclick="show_tab('loans')">Loans</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="summary-link" onclick="show_tab('summary')">Summary</a>
      </li>
    </ul>

    <div id='income-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Income</h4>
        <button class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#income-modal">Add
          Income</button>

        <h5>Ian's Income</h5>
        <table class="table table-striped w-50 mb-5">
          <tbody id="income-table-ian">
          </tbody>
        </table>

        <h5>Marty's Income</h5>
        <table class="table table-striped w-50">
          <tbody id="income-table-marty">
          </tbody>
        </table>

        <div id="income-modal" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Enter Income</h5>
              </div>
              <div class="modal-body">
                <input type="hidden" value="-1" id="income-id">
                <div class="form-group">
                  <label class="form-label fw-bold" for="income-amount">Income Amount</label>
                  <input type="number" value="" id="income-amount" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label fw-bold" for="income-person">Person</label>
                  <select id="income-person" class="form-select">
                    <option value="ian" selected>Ian</option>
                    <option value="marty">Marty</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_record('income');"
                  data-bs-dismiss="modal">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id='expenses-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Expenses</h4>
        <button class="btn btn-outline-primary mb-5" data-bs-toggle="modal" data-bs-target="#expenses-modal">Add
          Expense</button>

        <h5>Ian's Expenses</h5>
        <table class="table-striped w-75 mb-3">
          <tbody id="expenses-table-ian">
          </tbody>
        </table>

        <h5>Marty's Expenses</h5>
        <table class="table-striped w-75 mb-3">
          <tbody id="expenses-table-marty">
          </tbody>
        </table>

        <div id="expenses-modal" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Enter Expense</h5>
              </div>
              <div class="modal-body">
                <input id="expenses-id" type="hidden" val="-1">
                <div class="mb-3">
                  <label for="expenses-name" class="form-label fw-bold">Expense Name</label>
                  <input type="text" value="" id="expenses-name" class="form-control">
                </div>
                <div class="mb-3">
                  <label for="expenses-amount" class="form-label fw-bold">Expense Amount</label>
                  <input type="text" value="" id="expensew-amount" class="form-control">
                </div>
                <div class="mb-3">
                  <label for="expenses-category" class="form-label fw-bold">Expense Category</label>
                  <select id="expenses-category" class="form-select">
                    <option value="rent">Rent</option>
                    <option value="groceries">Groceries</option>
                    <option value="internet">Internet</option>
                    <option value="electricity">Electricity</option>
                    <option value="medical">Medical</option>
                    <option value="gas">Gas</option>
                    <option value="insurance">Insurnace</option>
                    <option value="subscriptions">Subscriptions</option>
                    <option value="travel">Travel</option>
                    <option value="food">Food</option>
                    <option value="fun">Fun</option>
                    <option value="loans">Loans</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="expenses-person" class="form-label fw-bold">Person</label>
                  <select id="expenses-person" class="form-select">
                    <option value="ian">Ian</option>
                    <option value="marty">Marty</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_record('expenses');"
                  data-bs-dismiss="modal">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id='accounts-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Accounts</h4>
        <table class="table-striped w-75">
          <tr onclick="new_account()">
            <td class="btn btn-outline-primary w-100">Add Account</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="assets-tab" style="display: none;">

      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Assets</h4>
        <table class="table-striped w-75">
          <tr onclick="new_asset()">
            <td class="btn btn-outline-primary w-100">Add Asset</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="loans-tab" style="display: none;">

      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Loans</h4>
        <table class="table-striped w-75">
          <tr onclick="new_loan()">
            <td class="btn btn-outline-primary w-100">Add Loan</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="summary-tab" style="display: none;">
      <div id='summary-tab' class="w-100 d-flex flex-column align-items-center">
        <h4>Summary</h4>
      </div>
    </div>
  </main>

  <div id="year-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Year</h5>
        </div>
        <div class="modal-body">
          <input type="text" value="" id="year" class="form-control">
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_year();"
            data-bs-dismiss="modal">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    class FinanceRecord {
      static records_list = {};
      static cur_year = 0;
      static cur_month = 0;

      static new_year = () => {
        const year_val = $('#year').val();
        const year = {};

        for (let i = 0; i < 12; i++) {
          year[i] = { income: [], expenses: [], assets: [], accounts: [], loans: [] };
        }

        this.records_list[year_val] = year;
        const year_option = $(`<option value=${year_val}>${year_val}</option>`);

        $('#year-select').append(`<option value=${year_val} selected>${year_val}</option>`);
        const sorted_years = $('#year-select').children().toArray().sort((a, b) => a.value < b.value);

        this.cur_year = year_val;

        $('#year-select').html('');
        $('#year-select').append(sorted_years);


        $('#year-select').trigger('change');
      };

      static new_record = (type) => {
        const record = {};
        let id = -1;

        let records = this.get_records_table(type);

        for (const element of $(`#${type}-modal`).find('input,select')) {
          const name = element.id.split('-')[1];

          if (name == 'id') {
            id = element.value;
          }
          else {
            record[element.id.split('-')[1]] = element.value;
          }
        }

        if (id == -1) {
          records.push(record);
        }
        else {
          records[id] = record;
        }

        reset_form(type);
        refresh_table(type);
      }

      static edit_record = (type, id) => {
        const record = this.records_list[this.cur_year][this.cur_month][type][id];
        $(`#${type}-id`).val(id);

        for (const [key, value] of Object.entries(record)) {
          const element = $(`#${type}-${key}`);

          if (element[0].nodeName == 'input') {
            element.val(value);
          }
          else if (element[0].nodeName == 'select') {
            element.find(`[value=${value}]`).prop('selected', true)
          }
        }

        $(`#${type}-modal`).modal('show');
      };

      static delete_record = (type, id) => {
        let records = this.records_list[this.cur_year][this.cur_month][type];
        let n = records.length;

        for (let i = id + 1; i < n; i++) {
          records[i - 1] = records[i];
        }

        records = records.splice(n - 1);

        refresh_tables();
      }

      static get_records_table = (table_name) => {
        return this.records_list[this.cur_year][this.cur_month][table_name];
      }

      static export_year = () => {
        const json = JSON.stringify({ year: this.cur_year, data: this.records_list[this.cur_year] });
        const blob = new Blob([json], { type: 'text/string' });
        const download = document.createElement('a');

        download.href = URL.createObjectURL(blob);
        download.download = 'personal_finance_sheet_' + this.cur_year + '.json';
        download.click();

        URL.revokeObjectURL(download.href);
      };

      static import_year = () => {
        const file = $('#import-year')[0].files[0];
        const reader = new FileReader();

        reader.addEventListener('load', (e) => {
          const data = JSON.parse(e.target.result);
          FinanceRecord.records_list[data.year] = data.data;

          $('#year-select').html('');

          for (const year in FinanceRecord.records_list) {
            $('#year-select').append(`<option value=${year}>${year}</option>`);
          }

          const sorted_years = $('#year-select').children().toArray().sort((a, b) => a.value < b.value);
          $('#year-select').html('');
          $('#year-select').append(sorted_years);

          FinanceRecord.cur_year = $('#year-select').find('option:first').val()
          $('#year-select').find('option:first').prop('selected', true);
          $('#year-select').trigger('change');
        });

        reader.readAsText(file);
      };
    };

    const hide_tabs = () => {
      const tab_names = $('.nav-link').toArray().map(x => x.getHTML().toLowerCase())
      for (const tab_name of tab_names) {
        $(`#${tab_name}-tab`).hide();
        $(`#${tab_name}-link`).removeClass('active')
      }
    };

    const show_tab = (tab_name) => {
      hide_tabs();
      $(`#${tab_name}-tab`).show();
      $(`#${tab_name}-link`).addClass('active');
    };

    const reset_form = (type) => {
      const inputs = $(`#${type}-modal`).find('input');

      for (const input of inputs) {
        input.value = '';

        if (input.id.split('-')[1] == 'id') {
          input.value = '-1';
        }
      }
    };

    const refresh_summary = () => {

    };

    const new_record_button = (type, id, record) => {
      switch (type) {
        case 'income': return `
        <td class="d-flex justify-content-between">
          <button onclick="FinanceRecord.edit_record('income', ${id})" class="btn btn-outline-success">$${record.amount}</button>
          <button class="btn btn-danger" onclick="FinanceRecord.delete_record('income', ${id})">Delete</button>
        </td>
        `;
      }
    }

    const refresh_table = (type) => {
      const records = FinanceRecord.get_records_table(type);

      $(`#${type}-table-ian`).html('');
      $(`#${type}-table-marty`).html('');

      for (const id in records) {
        const tr = $('<tr></tr>');
        tr.append(new_record_button(type, id, records[id]));

        $(`#${type}-table-${records[id].person}`).append(tr);
      }
    };

    const refresh_tables = () => {
      const links = $('.nav-link');

      for (const link of links) {
        refresh_table(link.text.toLowerCase());
      }

      refresh_summary();
    };

    $('#year-select,#month-select').on('change', () => {
      $('#nav-tabs').show();
      $('#export').show();
      refresh_tables();
    });
  </script>
</body>

</html>
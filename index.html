<!DOCTYPE html>

<html>

<head>
  <title>Personal Finance Dashboard</title>
  <link rel="stylesheet" href="./assets/bootstrap.min.css">
  <script src="./assets/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="./dev.js"></script>
</head>

<body>
  <nav class="p-2 navbar bg-primary text-light mb-3">
    <h3>Personal Finance Dashboard</h3>
    <label for="import-year" class="btn btn-secondary">Import Year</label>
    <input type="file" id="import-year" accept="json" class="d-none">
  </nav>
  <main class="px-2">
    <div>
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#year-modal">New Year</button>
      <div class="row">
        <div class="col-3">
          <label for="year" class="form-label fw-bold">Year</label>
          <select id="year-select" class="form-select mb-3" onchange="FinanceRecord.cur_year = this.value"></select>
        </div>
        <div class="col-3">
          <label for="month" class="form-label fw-bold">Month</label>
          <select id="month-select" class="form-select mb-3" onchange="FinanceRecord.cur_month = this.value">
            <option value="0" selected>January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
        </div>
      </div>
      <btn class="btn btn-primary" id="export" style="display: none;" onclick="FinanceRecord.export_year()">Export Year</btn>
    </div>

    <ul class="nav nav-tabs my-3" id="nav-tabs" style="display: none;">
      <li class="nav-item">
        <a class="nav-link" id="income-link" onclick="show_tab('income')">Income</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="expenses-link" onclick="show_tab('expenses')">Expenses</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="accounts-link" onclick="show_tab('accounts')">Accounts</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="assets-link" onclick="show_tab('assets')">Assets</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="loans-link" onclick="show_tab('loans')">Loans</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="summary-link" onclick="show_tab('summary')">Summary</a>
      </li>
    </ul>

    <div id='income-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Income</h4>
        <button class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#income-modal">Add Income</button>

        <h5>Ian's Income</h5>
        <table class="table table-striped w-50 mb-5">
          <tbody id="income-table-ian">
          </tbody>
        </table>

        <h5>Marty's Income</h5>
        <table class="table table-striped w-50">
          <tbody id="income-table-marty">
          </tbody>
        </table>

        <div id="income-modal" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Enter Income</h5>
              </div>
              <div class="modal-body">
                <input type="hidden" value="-1" id="income-id">
                <div class="form-group">
                  <label class="form-label fw-bold" for="income-amount">Income Amount</label>
                  <input type="number" value="" id="income-amount" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label fw-bold" for="income-person">Person</label>
                  <select id="income-person" class="form-select">
                    <option value="ian" selected>Ian</option>
                    <option value="marty">Marty</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_income();" data-bs-dismiss="modal">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id='expenses-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Expenses</h4>
        <table class="table-striped w-75">
          <tbody id="expenses-table">
            <tr data-bs-toggle="modal" data-bs-target="#expense-modal">
              <td class="btn btn-outline-primary w-100">Add Expense</td>
            </tr>
          </tbody>
        </table>

        <div id="expense-modal" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Enter Expense</h5>
              </div>
              <div class="modal-body">
                <input type="text" value="" id="expense-name" class="form-control">
                <select id="expense-category" class="form-select">
                  <option>

                  </option>
                </select>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_year();"
                  data-bs-dismiss="modal">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id='accounts-tab' style="display: none;">
      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Accounts</h4>
        <table class="table-striped w-75">
          <tr onclick="new_account()">
            <td class="btn btn-outline-primary w-100">Add Account</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="assets-tab" style="display: none;">

      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Assets</h4>
        <table class="table-striped w-75">
          <tr onclick="new_asset()">
            <td class="btn btn-outline-primary w-100">Add Asset</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="loans-tab" style="display: none;">

      <div class="w-100 d-flex flex-column align-items-center mb-3">
        <h4>Loans</h4>
        <table class="table-striped w-75">
          <tr onclick="new_loan()">
            <td class="btn btn-outline-primary w-100">Add Loan</td>
          </tr>
        </table>
      </div>
    </div>

    <div id="summary-tab" style="display: none;">
      <div id='summary-tab' class="w-100 d-flex flex-column align-items-center">
        <h4>Summary</h4>
      </div>
    </div>
  </main>

  <div id="year-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Year</h5>
        </div>
        <div class="modal-body">
          <input type="text" value="" id="year" class="form-control">
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="FinanceRecord.new_year();" data-bs-dismiss="modal">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    class FinanceRecord {
      static records_list = {};
      static cur_year = 0;
      static cur_month = 0;

      static new_year = () => {
        const year_val = $('#year').val();
        const year = {};

        for (let i = 0; i < 12; i++) {
          year[i] = { income: [], expenses: [], assets: [], accounts: [], loans: [] };
        }

        this.records_list[year_val] = year;
        const year_option = $(`<option value=${year_val}>${year_val}</option>`);

        $('#year-select').append(`<option value=${year_val} selected>${year_val}</option>`);
        const sorted_years = $('#year-select').children().toArray().sort((a, b) => a.value < b.value);

        $('#year-select').html('');
        $('#year-select').append(sorted_years);
        $('#year-select').trigger('change');

        this.cur_month = $('#month-select').val();
        this.cur_year = year_val;
      };

      static new_income = () => {
        const amount = $('#income-amount').val();
        const person = $('#income-person').val();

        const income_record = {amount: amount, person: person}

        const id = $('#income-id').val();

        if (id == -1) {
          this.records_list[this.cur_year][this.cur_month]['income'].push(income_record);
        }
        else {
          this.records_list[this.cur_year][this.cur_month]['income'][id] = income_record;
        }

        reset_income_form();
        refresh_income_table();
      };

      static edit_income = (id) => {
        const income_record = this.records_list[this.cur_year][this.cur_month]['income'];

        $('#income-id').val(id);
        $('#income-amount').val(income_record.amount);
        $('#income-person').find(`[value=${income_record.person}]`).prop('selected');

        $('#income-modal').modal('show');
      }

      static delete_income = (id) => {
        unset(this.records_list[this.cur_year][this.cur_month]['income'][id]);
        refresh_tables();
      }


      static new_expense = () => {

      };

      static new_account = () => {

      };

      static new_asset = () => {

      };

      static new_loan = () => {

      };

      static get_records_table = (table_name) => {
        return this.records_list[this.cur_year][this.cur_month][table_name];
      }

      static export_year = () => {

      };

      static import_year = () => {

      };
    };

    $('#year-select,#month-select').on('change', () => {
      $('#nav-tabs').show();
      $('#export').show();
    });

    const hide_tabs = () => {
      const tab_names = $('.nav-link').toArray().map(x => x.getHTML().toLowerCase())
      for (const tab_name of tab_names) {
        $(`#${tab_name}-tab`).hide();
        $(`#${tab_name}-link`).removeClass('active')
      }
    };

    const show_tab = (tab_name) => {
      hide_tabs();
      $(`#${tab_name}-tab`).show();
      $(`#${tab_name}-link`).addClass('active');
    };


    const reset_income_form = () => {
      $('#income-id').val(-1);
      $('#income-amount').val(0);
      $('#income-date').val('');
    }

    const refresh_tables = () => {
      refresh_income_table();
      refresh_expenses_table();
      refresh_accounts_table();
      refresh_assets_table();
      refresh_loans_table();
      refresh_summary();
    };

    const refresh_income_table = () => {
      const income_records = FinanceRecord.get_records_table('income');
      $('#income-table-ian').html('');
      $('#income-table-marty').html('');

      for (const id in income_records) {
        const tr = $(`<tr></tr>`);
        tr.append(`
        <td class="d-flex justify-content-between">
          <button onclick='FinanceRecord.edit_income(${id})' class="btn btn-outline-success">$${income_records[id].amount}</button>
          <button class="btn btn-danger" onclick="FinanceRecord.delete_income(${id})">Delete</button>
        </td>
        `);

        $(`#income-table-${income_records[id].person}`).append(tr);
      }
    };

    const refresh_expenses_table = () => {

    }

    const refresh_accounts_table = () => {

    };

    const refresh_assets_table = () => {

    };

    const refresh_loans_table = () => {

    };

    const refresh_summary = () => {

    };

    $('#year-select,#month-select').on('change', refresh_tables);

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('records', JSON.stringify(FinanceRecord.records_list));
    });

    $(() => {
      if (typeof DEV_ENV == undefined) {
        return;
      }

      FinanceRecord.records_list = JSON.parse(localStorage.getItem('records'));

      for (const year in FinanceRecord.records_list) {
        $('#year-select').append(`<option value=${year}>${year}</option>`);
      }

      const sorted_years = $('#year-select').children().toArray().sort((a, b) => a.value < b.value);
      $('#year-select').html('');
      $('#year-select').append(sorted_years);

      FinanceRecord.cur_year = $('#year-select').find('option:first').val()
      $('#year-select').find('option:first').prop('selected', true);
      $('#year-select').trigger('change');
    });
  </script>
</body>

</html>